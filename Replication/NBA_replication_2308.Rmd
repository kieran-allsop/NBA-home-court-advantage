---
title: "A Mere Fan Effect on Home Court Advantage"
author: "Scott C. Ganz and Kieran Allsop"
date: "7/26/2023"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(rvest)
library(tidyr)
library(stringr)
library(readxl)
library(readr)
library(haven)
library(lubridate)
library(ggplot2)
library(ggthemes)
library(ggpubr)
library(grid)
library(gridExtra)
library(survival)
library(survminer)
```

## Introduction

This is an R Markdown document that replicates the data collection, sorting, and analysis in the article [A Mere Effect on Home Court Advantage](). The code was originally run on R.4.0.1. Updated versions of R may have been released since this replication file was written.

You will need to install the following packages into R to run this code:

* dplyr
* tidyr
* rvest
* readr
* readxl
* haven
* stringr
* lubridate
* ggplot2
* ggthemes
* ggpubr
* grid
* gridExtra

Section 1 describes the data scraping and collection process as well as all data formatting. Section 2 reproduces the figures found in the paper. Section 3 computes calculations found in the paper. Note, section 2 and section 3 can be run without running section 1 using the final data set saved as data/nba_final_data.csv. Data scraping was originally completed in May 2021 and then updated in May 2022 to include the 2021-22 season and all COVID-19 data.

## 1) Scrape Data

### 2016-2019 Scrape

```{r scrape16, eval=FALSE}
year <- c("15", "16", "17", "18", "19", "22")

rawdata <- list()
data <- list()
## Months of regular season play for all 5 years
months = c("october", "november", "december", "january", "february", "march")

for (i in 1:length(year)){
  rawdata[[year[i]]] <- tibble(date = character(),
                               hometeam = character(),
                               homepts = numeric(),
                               awayteam = character(),
                               awaypts = numeric(),
                               attendance = character(),
                               month = character())
  
  for (j in 1:length(months)) {
    gamelist <- read_html(str_c("https://www.basketball-reference.com/leagues/NBA_20", year[i],"_games-", months[j], ".html"))
    
    x <- gamelist %>% html_element("#schedule") %>% html_table()
    names(x) <- c("date", "time", "awayteam", "awaypts", "hometeam", "homepts", "xx", "yy",
                  "attendance", "arena", "zz")
    
    d <- x %>% select(date, hometeam, homepts, awayteam, awaypts, attendance) %>%
      mutate(month = months[j])
    
    rawdata[[year[i]]] <- rawdata[[year[i]]] %>% bind_rows(d)
    Sys.sleep(runif(1))
  }
  
## Run April separately due to char variable for home and away points in .html file
  gamelist <- read_html(str_c("https://www.basketball-reference.com/leagues/NBA_20", year[i],"_games-april.html"))
  
  x <- gamelist %>% html_element("#schedule") %>% html_table()
  names(x) <- c("date", "time", "awayteam", "awaypts", "hometeam", "homepts", "xx", "yy",
                "attendance", "arena", "zz")
  d <- x %>% select(date, hometeam, homepts, awayteam, awaypts, attendance) %>%
    filter(date!="Playoffs") %>%
    mutate(month = months[i], homepts = as.numeric(homepts), awaypts = as.numeric(awaypts))
  rawdata[[year[i]]] <- rawdata[[year[i]]] %>% bind_rows(d)
  
  data[[year[i]]] <- rawdata[[year[i]]] %>% mutate(attendance = attendance %>% str_replace(",", "") %>% as.numeric) %>%
    mutate(homewin = homepts > awaypts, homemargin = homepts - awaypts,
           date = substring(date, 6),
           date = as.Date(date, format = "%b %d, %Y"),
           day = weekdays(date))
  
## Capacity limits collected by hand from nba.com.
  capacity_lim<- read_excel("data/stadium_capacity_limits.xlsx", sheet = str_c("max_cap", year[i])) %>%
    select(-"source") %>%
    rename(hometeam=team)
  
  data[[year[i]]] <- merge(data[[year[i]]], capacity_lim, all.x=T) %>%
    mutate(pct_of_max = attendance/max_capacity, capacity = max_capacity,
           pct_of_cap = attendance/capacity, pct_allowed = 1)
  
  data[[year[i]]] <- data[[year[i]]] %>% group_by(hometeam) %>% 
    mutate(gamenumber = 1:n()) %>% ungroup()
  
  data[[year[i]]] <- data[[year[i]]] %>% mutate(reg_remove = 0)
  Sys.sleep(runif(1))
}
```

### 2020 Scrape

```{r scrape20, eval=FALSE}
knitr::opts_chunk$set(eval = FALSE)
rawdata20 <- tibble(date = character(),
                  hometeam = character(),
                  homepts = numeric(),
                  awayteam = character(),
                  awaypts = numeric(),
                  attendance = character(),
                  month = character())

months = c("october-2019", "november", "december", "january", "february", "march")

lastday = as.Date("2020-03-10")

for (i in 1:length(months)) {
  gamelist <- read_html(str_c("https://www.basketball-reference.com/leagues/NBA_2020_games-", months[i], ".html"))
  
  x <- gamelist %>% html_element("#schedule") %>% html_table()
  names(x) <- c("date", "time", "awayteam", "awaypts", "hometeam", "homepts", "xx", "yy",
                "attendance", "arena", "zz")
  d <- x %>% select(date, hometeam, homepts, awayteam, awaypts, attendance) %>%
    mutate(month = months[i])
  rawdata <- rawdata %>% bind_rows(d)
}

data <- rawdata %>% mutate(attendance = attendance %>% str_replace(",", "") %>% as.numeric,
                           homewin = homepts > awaypts,
                           homemargin = homepts - awaypts)

data <- data %>%
  mutate(date = substring(date, 6),
         date = as.Date(date, format = "%b %d, %Y"),
         day = weekdays(date)) %>%
  filter(date<=lastday)

## Capacity limits collected by hand from nba.com
capacity_lim<- read_excel("data/stadium_capacity_limits.xlsx", sheet = "max_cap20") %>%
  rename(hometeam=team) %>% select(-...4)

data <- merge(data, capacity_lim, all.x=T) %>%
  mutate(pct_of_max = attendance/max_capacity, capacity = max_capacity,
         pct_of_cap = attendance/capacity, pct_allowed = 1)

data <- data %>% group_by(hometeam) %>% 
  mutate(gamenumber = 1:n()) %>% ungroup()

data20 <- data %>% mutate(reg_remove = 0)
```

### 2021 Scrape

```{r scrape21, eval=FALSE}
knitr::opts_chunk$set(eval = FALSE)
rawdata <- tibble(date = character(),
                  hometeam = character(),
                  homepts = numeric(),
                  awayteam = character(),
                  awaypts = numeric(),
                  attendance = character(),
                  month = character())

months = c("december", "january", "february", "march", "april", "may")

## Last day of regular season
lastday = as.Date("2021-05-16")

## Scrape data
for (i in 1:length(months)) {
  gamelist <- read_html(str_c("https://www.basketball-reference.com/leagues/NBA_2021_games-", months[i], ".html"))
  
  x <- gamelist %>% html_element("#schedule") %>% html_table()
  names(x) <- c("date", "time", "awayteam", "awaypts", "hometeam", "homepts", "xx", "yy",
                "attendance", "arena", "zz")
  d <- x %>% select(date, hometeam, homepts, awayteam, awaypts, attendance) %>%
    mutate(month = months[i])
  rawdata <- rawdata %>% bind_rows(d)
}

data <- rawdata %>% mutate(attendance = attendance %>% str_replace(",", "") %>% as.numeric,
                           homewin = homepts > awaypts,
                           homemargin = homepts - awaypts)

data <- data %>%
  mutate(date = substring(date, 6),
         date = as.Date(date, format = "%b %d, %Y")) %>%
  filter(date<=lastday)

data <- data %>% group_by(hometeam) %>%
  mutate(gamenumber = 1:n()) %>% ungroup()

## Capacity limits were collected by hand
capacity_lim <- read_excel("data/stadium_capacity_limits.xlsx", sheet = "long") %>%
  select(-source) %>%
  rename(hometeam=team, pct_allowed = percentage) %>%
  mutate(date = as.Date(date),
         capacity = floor(capacity))

capacity_lim <- capacity_lim %>%
  group_by(hometeam) %>% 
  complete(date = seq.Date(min(date), lastday, by="day")) %>%
  fill(stadium, max_capacity, capacity, pct_allowed)

data <- data %>% left_join(capacity_lim) %>%
  filter(!is.na(homepts)) 

## Flag Pacers, Heat, and Kings to be removed from regression for unreliable attendance data and change games where an
## official attendance was listed on nba.com but basketball reference had 0
data21 <- data %>%
  mutate(attendance = ifelse(hometeam=="Washington Wizards" & date=="2021-05-03", 2133, attendance),
         attendance = ifelse(hometeam=="Portland Trail Blazers" & date=="2021-05-07", 1939, attendance),
         attendance = ifelse(hometeam=="Charlotte Hornets" & date=="2021-03-11", 500, attendance),
         attendance = ifelse(hometeam=="Orlando Magic" & date=="2021-05-05", 4249, attendance),
         attendance = ifelse(hometeam=="Los Angeles Clippers" & date=="2021-02-21", 0, attendance),
         attendance = ifelse(hometeam=="Portland Trail Blazers" & date=="2021-03-23", 0, attendance),
         attendance = ifelse(hometeam=="Golden State Warriors" & date=="2021-02-15", 0, attendance),
         attendance = ifelse(hometeam=="Golden State Warriors" & date=="2021-02-17", 0, attendance),
         attendance = ifelse(hometeam=="Los Angeles Clippers" & date=="2021-02-17", 0, attendance),
         attendance = ifelse(hometeam=="Boston Celtics" & date=="2021-05-02", 0, attendance),
         capacity = ifelse(hometeam=="Minnesota Timberwolves" & date=="2021-04-13", 0, capacity),
         capacity = ifelse(hometeam=="Minnesota Timberwolves" & date=="2021-04-14", 0, capacity),
         capacity = ifelse(hometeam=="Memphis Grizzlies" & date=="2021-02-17", 0, capacity),
         day=weekdays(date))%>%
  mutate(pct_of_cap = attendance/capacity,
         pct_of_max = attendance/max_capacity) %>% 
  mutate(reg_remove = ifelse(capacity>0 & attendance==0, 1, 0),
         reg_remove = ifelse(hometeam=="Indiana Pacers" | hometeam=="Miami Heat" | hometeam=="Sacramento Kings", 1, reg_remove))
```

### Scrape Box Scores

```{r boxscores, eval=FALSE}
knitr::opts_chunk$set(eval = FALSE)
AWAY <- tibble()
HOME <- tibble()

## Collect all dates between start date and end date of each season
days15 <- format(seq(as.Date("2014-10-28"), as.Date("2015-04-15"), by="days"), format="%d-%m-%Y")
days16 <- format(seq(as.Date("2015-10-27"), as.Date("2016-04-13"), by="days"), format="%d-%m-%Y")
days17 <- format(seq(as.Date("2016-10-25"), as.Date("2017-04-12"), by="days"), format="%d-%m-%Y")
days18 <- format(seq(as.Date("2017-10-17"), as.Date("2018-04-11"), by="days"), format="%d-%m-%Y")
days19 <- format(seq(as.Date("2018-10-16"), as.Date("2019-04-10"), by="days"), format="%d-%m-%Y")
days20 <- format(seq(as.Date("2019-10-22"), as.Date("2020-03-10"), by="days"), format="%d-%m-%Y")
days21 <- format(seq(as.Date("2020-12-22"), as.Date("2021-05-16"), by="days"), format="%d-%m-%Y")
days22 <- format(seq(as.Date("2021-10-19"), as.Date("2022-04-10"), by="days"), format="%d-%m-%Y")
days <- c(days15, days16, days17, days18, days19, days20, days21, days22)

## Separate dates into table and remove dates there were no games during the season (e.g. all-star break)
date_vec <- tibble(day = substr(days, 1, 2),
                   month = substr(days, 4, 5),
                   year = substr(days, 7, 10))
date_vec <- date_vec %>%
  mutate(day = ifelse(substr(day, 1, 1)=="0", substr(day, 2, 2), day),
         month = ifelse(substr(month, 1, 1)=="0", substr(month, 2, 2), month)) %>%
  mutate(nogame = ifelse((day=="24" & month=="12" & year=="2020") | (day=="5" & month=="3" & year=="2021") | 
                           (day=="6" & month=="3" & year=="2021") | (day=="7" & month=="3" & year=="2021") |
                           (day=="8" & month=="3" & year=="2021") | (day=="9" & month=="3" & year=="2021") |
                           (day=="22" & month=="11" & year=="2018") | (day=="24" & month=="12" & year=="2018") |
                           (day=="15" & month=="2" & year=="2019") | (day=="16" & month=="2" & year=="2019") |
                           (day=="17" & month=="2" & year=="2019") | (day=="18" & month=="2" & year=="2019") |
                           (day=="20" & month=="2" & year=="2019") | (day=="8" & month=="4" & year=="2019") |
                           (day=="23" & month=="11" & year=="2017") | (day=="24" & month=="12" & year=="2017") |
                           (day=="16" & month=="2" & year=="2018") | (day=="17" & month=="2" & year=="2018") |
                           (day=="18" & month=="2" & year=="2018") | (day=="19" & month=="2" & year=="2018") |
                           (day=="20" & month=="2" & year=="2018") | (day=="21" & month=="2" & year=="2018") |
                           (day=="19" & month=="2" & year=="2019") | (day=="2" & month=="4" & year=="2018") |
                           (day=="24" & month=="11" & year=="2016") | (day=="24" & month=="12" & year=="2016") |
                           (day=="17" & month=="2" & year=="2017") | (day=="18" & month=="2" & year=="2017") |
                           (day=="19" & month=="2" & year=="2017") | (day=="20" & month=="2" & year=="2017") |
                           (day=="21" & month=="2" & year=="2017") | (day=="22" & month=="2" & year=="2017") |
                           (day=="26" & month=="11" & year=="2015") | (day=="24" & month=="12" & year=="2015") |
                           (day=="12" & month=="2" & year=="2016") | (day=="13" & month=="2" & year=="2016") |
                           (day=="14" & month=="2" & year=="2016") | (day=="15" & month=="2" & year=="2016") |
                           (day=="16" & month=="2" & year=="2016") | (day=="17" & month=="2" & year=="2016") |
                           (day=="4" & month=="4" & year=="2016") | (day=="27" & month=="11" & year=="2014") |
                           (day=="24" & month=="12" & year=="2014") | (day=="13" & month=="2" & year=="2015") |
                           (day=="14" & month=="2" & year=="2015") | (day=="15" & month=="2" & year=="2015") |
                           (day=="16" & month=="2" & year=="2015") | (day=="17" & month=="2" & year=="2015") |
                           (day=="18" & month=="2" & year=="2015") | (day=="28" & month=="11" & year=="2019") |
                           (day=="24" & month=="12" & year=="2019") | (day=="14" & month=="2" & year=="2020") |
                           (day=="15" & month=="2" & year=="2020") | (day=="16" & month=="2" & year=="2020") |
                           (day=="17" & month=="2" & year=="2020") | (day=="18" & month=="2" & year=="2020") |
                           (day=="19" & month=="2" & year=="2020") | (day=="25" & month=="11" & year=="2021") |
                           (day=="24" & month=="12" & year=="2021") | (day=="18" & month=="2" & year=="2022") |
                           (day=="19" & month=="2" & year=="2022") | (day=="20" & month=="2" & year=="2022") |
                           (day=="21" & month=="2" & year=="2022") | (day=="22" & month=="2" & year=="2022") |
                           (day=="23" & month=="2" & year=="2022") | (day=="4" & month=="4" & year=="2022"), 1, 0)) %>%
  filter(nogame==0) %>% select(-nogame)

## Loops through every day listed in date_vec
for (j in 1:nrow(date_vec)){

  ## Collect list of links to boxscores of games that happened on that date
  gamelist <- read_html(str_c("https://www.basketball-reference.com/boxscores/index.fcgi?month=",date_vec$month[j],"&day=",date_vec$day[j],"&year=",date_vec$year[j]))
  x <- gamelist %>% html_nodes(".links a:nth-child(1)") %>% html_attr("href")

  ## Loops through every boxscore in x and obtains team names and home and away stats for each game
  for (i in 1:length(x)){
    boxscore <- read_html(str_c("https://www.basketball-reference.com/",x[i]))

    names <- boxscore %>% html_nodes("strong a") %>% html_attr("href") %>%
      str_remove("/teams/") %>% str_remove("/2015.html") %>% str_remove("/2016.html") %>% 
      str_remove("/2017.html") %>% str_remove("/2018.html") %>% str_remove("/2019.html") %>% 
      str_remove("/2020.html") %>% str_remove("/2021.html") %>% str_remove("/2022.html")
    date <- boxscore %>% html_nodes(".scorebox_meta div:nth-child(1)") %>% html_text()

    away <- boxscore %>% html_element(str_c("#box-",names[1],"-game-basic")) %>% html_table()
    colnames(away) <- away[1,]
    away <- away %>% filter(Starters=="Team Totals") %>%
      mutate(team=names[1], HA = "away", date = date) %>%
      select(c("team", "HA", "date", "FG", "FGA", "FG%", "3P", "3PA", "3P%", "FT", "FTA", "FT%", "PF", "PTS"))
    home <- boxscore %>% html_element(str_c("#box-",names[2],"-game-basic")) %>% html_table()
    colnames(home) <- home[1,]
    home <- home %>% filter(Starters=="Team Totals") %>%
      mutate(team=names[2], HA = "home", date = date) %>%
      select(c("team", "HA", "date", "FG", "FGA", "FG%", "3P", "3PA", "3P%", "FT", "FTA", "FT%", "PF", "PTS"))
  
    AWAY <- AWAY %>% rbind(away)
    HOME <- HOME %>% rbind(home)
  }
  print(j)
}

## Format dates and label seasons
HOME1 <- HOME %>%
  mutate(date = str_split_fixed(date, ", ", 2)[,2],
         date = str_remove(date, ","),
         date = as.Date(date, format = "%B %d %Y"))

AWAY1 <- AWAY %>%
  mutate(date = str_split_fixed(date, ", ", 2)[,2],
         date = str_remove(date, ","),
         date = as.Date(date, format = "%B %d %Y"))

## Format team names for later merge
HOME1 <- HOME1 %>%
  mutate(team = ifelse(team=="LAL", "Los Angeles Lakers", team), team = ifelse(team=="NOP", "New Orleans Pelicans", team),
         team = ifelse(team=="SAS", "San Antonio Spurs", team), team = ifelse(team=="BOS", "Boston Celtics", team),
         team = ifelse(team=="CHO", "Charlotte Hornets", team), team = ifelse(team=="DEN", "Denver Nuggets", team),
         team = ifelse(team=="IND", "Indiana Pacers", team), team = ifelse(team=="MEM", "Memphis Grizzlies", team),
         team = ifelse(team=="MIA", "Miami Heat", team), team = ifelse(team=="NYK", "New York Knicks", team),
         team = ifelse(team=="PHO", "Phoenix Suns", team), team = ifelse(team=="POR", "Portland Trail Blazers", team),
         team = ifelse(team=="SAC", "Sacramento Kings", team), team = ifelse(team=="TOR", "Toronto Raptors", team),
         team = ifelse(team=="UTA", "Utah Jazz", team), team = ifelse(team=="CLE", "Cleveland Cavaliers", team),
         team = ifelse(team=="DAL", "Dallas Mavericks", team), team = ifelse(team=="LAC", "Los Angeles Clippers", team),
         team = ifelse(team=="MIN", "Minnesota Timberwolves", team), team = ifelse(team=="ORL", "Orlando Magic", team),
         team = ifelse(team=="CHI", "Chicago Bulls", team), team = ifelse(team=="MIL", "Milwaukee Bucks", team),
         team = ifelse(team=="ATL", "Atlanta Hawks", team), team = ifelse(team=="DET", "Detroit Pistons", team),
         team = ifelse(team=="GSW", "Golden State Warriors", team), team = ifelse(team=="HOU", "Houston Rockets", team),
         team = ifelse(team=="OKC", "Oklahoma City Thunder", team), team = ifelse(team=="PHI", "Philadelphia 76ers", team),
         team = ifelse(team=="WAS", "Washington Wizards", team), team = ifelse(team=="BRK", "Brooklyn Nets", team))

AWAY1 <- AWAY1 %>%
  mutate(team = ifelse(team=="LAL", "Los Angeles Lakers", team), team = ifelse(team=="NOP", "New Orleans Pelicans", team),
         team = ifelse(team=="SAS", "San Antonio Spurs", team), team = ifelse(team=="BOS", "Boston Celtics", team),
         team = ifelse(team=="CHO", "Charlotte Hornets", team), team = ifelse(team=="DEN", "Denver Nuggets", team),
         team = ifelse(team=="IND", "Indiana Pacers", team), team = ifelse(team=="MEM", "Memphis Grizzlies", team),
         team = ifelse(team=="MIA", "Miami Heat", team), team = ifelse(team=="NYK", "New York Knicks", team),
         team = ifelse(team=="PHO", "Phoenix Suns", team), team = ifelse(team=="POR", "Portland Trail Blazers", team),
         team = ifelse(team=="SAC", "Sacramento Kings", team), team = ifelse(team=="TOR", "Toronto Raptors", team),
         team = ifelse(team=="UTA", "Utah Jazz", team), team = ifelse(team=="CLE", "Cleveland Cavaliers", team),
         team = ifelse(team=="DAL", "Dallas Mavericks", team), team = ifelse(team=="LAC", "Los Angeles Clippers", team),
         team = ifelse(team=="MIN", "Minnesota Timberwolves", team), team = ifelse(team=="ORL", "Orlando Magic", team),
         team = ifelse(team=="CHI", "Chicago Bulls", team), team = ifelse(team=="MIL", "Milwaukee Bucks", team),
         team = ifelse(team=="ATL", "Atlanta Hawks", team), team = ifelse(team=="DET", "Detroit Pistons", team),
         team = ifelse(team=="GSW", "Golden State Warriors", team), team = ifelse(team=="HOU", "Houston Rockets", team),
         team = ifelse(team=="OKC", "Oklahoma City Thunder", team), team = ifelse(team=="PHI", "Philadelphia 76ers", team),
         team = ifelse(team=="WAS", "Washington Wizards", team), team = ifelse(team=="BRK", "Brooklyn Nets", team))

## Identify between home and away stats for later merge
HOME1 <- HOME1 %>%
  rename(hometeam=team, home_FG = FG, home_FGA = FGA, home_FGpct = 'FG%', home_3P = '3P', home_3PA = '3PA',
         home_3Ppct = '3P%', home_FT = FT, home_FTA = FTA, home_FTpct = 'FT%', home_PF = PF, home_PTS = PTS) %>%
  select(-HA)

AWAY1 <- AWAY1 %>%
  rename(awayteam=team, away_FG = FG, away_FGA = FGA, away_FGpct = 'FG%', away_3P = '3P', away_3PA = '3PA',
         away_3Ppct = '3P%', away_FT = FT, away_FTA = FTA, away_FTpct = 'FT%', away_PF = PF, away_PTS = PTS) %>%
  select(-HA)

#write_csv(HOME1, "data/boxscore_stats_home.csv")
#write_csv(AWAY1, "data/boxscore_stats_away.csv")

```

### Combine Years and Box Scores

```{r combinedata, eval=FALSE}
knitr::opts_chunk$set(eval = FALSE)
## These are dates the playoffs (post season) started. Remove so we only have reg. season
data[["15"]] <- data[["15"]] %>% filter(date<"2015-04-18") %>% mutate(season="2015")
data[["16"]] <- data[["16"]] %>% filter(date<"2016-04-16") %>% mutate(season="2016")
data[["17"]] <- data[["17"]] %>% filter(date<"2017-04-15") %>% mutate(season="2017")
data[["18"]] <- data[["18"]] %>% filter(date<"2018-04-14") %>% mutate(season="2018")
data[["19"]] <- data[["19"]] %>% filter(date<"2019-04-13") %>% mutate(season="2019")
data[["20"]] <- data20 %>% mutate(season="2020")
data[["21"]] <- data21 %>% mutate(season="2021")
data[["22"]] <- data[["22"]] %>% filter(date<"2022-04-11") %>% mutate(season="2022")


DATA_FINAL <- rbind(data[["15"]], data[["16"]])
DATA_FINAL <- rbind(DATA_FINAL, data[["17"]])
DATA_FINAL <- rbind(DATA_FINAL, data[["18"]])
DATA_FINAL <- rbind(DATA_FINAL, data[["19"]])
DATA_FINAL <- rbind(DATA_FINAL, data[["20"]])
DATA_FINAL <- rbind(DATA_FINAL, data[["21"]])
DATA_FINAL <- rbind(DATA_FINAL, data[["22"]])

rm(d, gamelist, x, i, j, months, year, capacity_lim, lastday, rawdata, rawdata20, data20, data21)

## Merge in home and away stats scraped from boxscores in game_scraper.R
away_stats <- read_csv("data/boxscore_stats_away.csv")
home_stats <- read_csv("data/boxscore_stats_home.csv")

DATA_FINAL <- merge(DATA_FINAL, home_stats, by=c("hometeam", "date"), all.x = T)
DATA_FINAL <- merge(DATA_FINAL, away_stats, by=c("awayteam", "date"), all.x = T)

DATA_FINAL <- DATA_FINAL %>% group_by(hometeam, season) %>% 
  mutate(homeID = cur_group_id()) %>% ungroup()

DATA_FINAL <- DATA_FINAL %>% group_by(awayteam, season) %>% 
  mutate(awayID = cur_group_id()) %>% ungroup()

```

### Collect and combine COVID-19 data

```{r coviddata, eval=FALSE}
knitr::opts_chunk$set(eval = FALSE)
## Import NYT covid data
covid2020 <- read_csv("data/us-counties-2020-covidcases.csv") %>%
  mutate(fips=ifelse(county=="New York City", 36999, fips))
covid2021 <- read_csv("data/us-counties-2021-covidcases.csv") %>%
  mutate(fips=ifelse(county=="New York City", 36999, fips))
covid2022 <- read_csv("data/us-counties-2022-covidcases.csv") %>%
  mutate(fips=ifelse(county=="New York City", 36999, fips))

c2020tot <- covid2020 %>% group_by(date) %>%
  summarize(UScases=sum(cases), USdeaths=sum(deaths, na.rm=T)) %>% ungroup()
covid2020 <- merge(covid2020, c2020tot, all.x=T)
c2021tot <- covid2021 %>% group_by(date) %>%
  summarize(UScases=sum(cases), USdeaths=sum(deaths, na.rm=T)) %>% ungroup()
covid2021 <- merge(covid2021, c2021tot, all.x=T)
c2022tot <- covid2022 %>% group_by(date) %>%
  summarize(UScases=sum(cases), USdeaths=sum(deaths, na.rm=T)) %>% ungroup()
covid2022 <- merge(covid2022, c2022tot, all.x=T)

## Import 2021 population data
popdata <- read_csv("data/censusbureau_popdata2021.csv") 

popdataUS <- popdata %>% filter(SUMLEV=="040") %>%
  summarise(USpopulation=sum(POPESTIMATE2021))

popdata <- popdata %>%
  mutate(fips=paste0(STATE, COUNTY)) %>%
  select(fips, POPESTIMATE2021) %>%
  rename(population=POPESTIMATE2021)

## Create NYC population from 5 boroughs (NYT only gives covid cases for all of NYC)
popdataNY <- popdata %>%
  filter(fips=="36005" | fips=="36047" | fips=="36061" | fips=="36081" | fips=="36085") %>%
  summarise(population=sum(population)) %>%
  mutate(fips="36999")
popdata <- rbind(popdata, popdataNY)
popdata <- merge(popdata, popdataUS)

## Combine all data
covid <- rbind(covid2020, covid2021)
covid <- rbind(covid, covid2022)
rm(covid2020, covid2021, covid2022, c2020tot, c2021tot, c2022tot)
covid <- merge(covid, popdata)
rm(popdata, popdataNY, popdataUS)

## Import stadium location data and merge with covid data
stadiums <- read_excel("data/stadium_counties.xlsx") %>%
  mutate(fips=as.character(fips),
         fips=ifelse(str_length(fips)==4, paste0("0",fips), fips)) %>%
  select(Team, fips)
covid <- merge(covid, stadiums)
rm(stadiums)

## Create case/death rate variables
covid <- covid %>%
  mutate(cases100k = (cases/population)*100000,
         death100k = (deaths/population)*100000,
         UScases100k = (UScases/USpopulation)*100000,
         USdeath100k = (USdeaths/USpopulation)*100000) %>%
  select(date, Team, cases100k, death100k, UScases100k, USdeath100k) %>%
  rename(hometeam=Team)

covid <- covid %>%
  group_by(hometeam, date) %>% summarise(cases100k=mean(cases100k), death100k=mean(death100k),
                                         UScases100k=mean(UScases100k), USdeath100k=mean(USdeath100k)) %>% 
  ungroup() %>%
  group_by(hometeam) %>% mutate(cases100k2wk = cases100k-lag(cases100k, 14), 
                                death100k2wk = death100k-lag(death100k, 14),
                                UScases100k2wk = UScases100k-lag(UScases100k, 14), 
                                USdeath100k2wk = USdeath100k-lag(USdeath100k, 14)) %>% ungroup()

#write_csv(covid, "data/covid_cases_byTeam.csv")

DATA_FINAL <- merge(DATA_FINAL, covid, all.x = T)

```

### Collect and combine team performance data

```{r formvars, eval=FALSE}
knitr::opts_chunk$set(eval = FALSE)

teams <- unique(DATA_FINAL$hometeam)
form <- tibble()

## Create variables for recent team performance
for(i in 1:length(teams)){
  x <- DATA_FINAL %>% filter(hometeam==teams[i] | awayteam==teams[i])
  x <- x %>% mutate(WIN=ifelse((hometeam==teams[i] & homewin==TRUE)|(awayteam==teams[i] & homewin==FALSE), 1, 0))
  x <- x %>% group_by(season) %>%
    mutate(form1=lag(WIN, 1), 
           form5=(lag(WIN, 1)+lag(WIN, 2)+lag(WIN, 3)+lag(WIN, 4)+lag(WIN, 5))/5,
           form10=(lag(WIN, 1)+lag(WIN, 2)+lag(WIN, 3)+lag(WIN, 4)+lag(WIN, 5)+
                     lag(WIN, 6)+lag(WIN, 7)+lag(WIN, 8)+lag(WIN, 9)+lag(WIN, 10))/10) %>% ungroup() %>%
    select(date, form1, form5, form10) %>%
    mutate(team=teams[i])
  
  form <- rbind(form, x)
}

formh <- form %>% rename(hometeam=team, form1h=form1, form5h=form5, form10h=form10)
forma <- form %>% rename(awayteam=team, form1a=form1, form5a=form5, form10a=form10)

DATA_FINAL <- merge(DATA_FINAL, formh, all.x=T)
DATA_FINAL <- merge(DATA_FINAL, forma, all.x=T)
rm(form, formh, forma, teams, x, i, covid)

#write_csv(DATA_FINAL, "data/nba_final_data.csv")
#write_dta(DATA_FINAL, "data/nba_final_data.dta")

```

## 2) Create Figures

First, read the data back in so the data-scraping process does not have to repeat for every analysis.

```{r readdata}
d <- read_csv("data/nba_final_data.csv") %>%
  mutate(season = as.factor(season))

## Keep one data frame for only the 2021 season with vars. removed as described in the paper
d21 <- d %>% filter(season==2021) %>% filter(reg_remove==0)
```

### Figure 1 - Mean Home Margin Across Years

```{r fig1}

## Create season indicators for "2021 (No Fans)", "2021 (Fans)", and "Non 2021". Bind together with the main dataset
d21_1 <- d %>% filter(season==2021) %>%
  filter(reg_remove==0) %>%
  mutate(season = ifelse(attendance==0, "2021 (No Fans)", "2021 (Fans)"))

d21_2 <- d %>% filter(season!=2021) %>%
  filter(reg_remove==0) %>%
  mutate(season = "Non 2021")
                            
means_ext <- rbind(d, d21_2) 
means_ext <- rbind(means_ext, d21_1) %>%
  mutate(temp = 1)

## Find mean home court advantage by season including confidence intervals
means <- means_ext %>%
  group_by(season) %>%
  summarize(homemargin1 = mean(homemargin), sd = sd(homemargin), N = sum(temp)) %>%
  ungroup() %>%
  mutate(se = sd/sqrt(N),
         ci = 1.96*se)

## Required for t-test calculations in section 3
margins_non21 <- means_ext %>% filter(season=="Non 2021") %>% select(homemargin)
margins_nofans <- means_ext %>% filter(season=="2021 (No Fans)") %>% select(homemargin)
margins_fans <- means_ext %>% filter(season=="2021 (Fans)") %>% select(homemargin)

## Plot Figure 1 and save    
MEANS2 <- ggplot(means, aes(x = season, y = homemargin1)) +
  geom_errorbar(aes(ymin=homemargin1-ci, ymax=homemargin1+ci), width=.3) +
  geom_point(stat="identity") + theme_few() +
  theme(legend.position = "none")+
  ylab("Average Home Margin") + xlab("Season") +
  geom_vline(xintercept = 8.5, linetype = "dashed", color = "darkgray") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray") + 
  theme(axis.text.x = element_text(angle = 45, vjust=1, hjust=1))
MEANS2
#ggsave("graphs/av_homemargin1.png", height=6, width=9)

```

### Figure 2 - Attendance by game histogram 2020-21

```{r fig2}

## Plot Figure 2 and save    
attendance_hist <- ggplot(d21, aes(x=attendance)) +
  geom_histogram(fill="gray", bins=10) + theme_few() +
  xlab("Attendance") + ylab("Count") + ylim(0,475)
attendance_hist
#ggsave("graphs/attendance_hist.png", height=6, width=9)
```

### Figure 3 - Max capacity by game histogram 2020-21

```{r fig3}

## Plot Figure 3 and save    
capacity_hist <- ggplot(d21, aes(x=capacity)) +
  geom_histogram(fill="gray", bins=10) + theme_few() +
  xlab("Capacity") + ylab("Count") + ylim(0,475)
capacity_hist
#ggsave("graphs/capacity_hist.png", height=6, width=9)
```

### Figure 4 - Bivariate relationship (attendance vs capacity)

```{r fig4}
##Keep oly observations with positive capacity and find correlation
d21corr <- d21 %>% filter(capacity>0)
correlation <- cor(d21corr$attendance, d21corr$capacity)

text = grobTree(textGrob(paste("Pearson Correlation : ", round(cor(d21corr$attendance, d21corr$capacity), 4) ), 
                          x = 0.02, y = 0.97, hjust = 0, gp = gpar(col = "black", fontsize = 11)))

## Plot Figure 4 and save    
attendance_corr <- ggplot(d21corr, aes(x=capacity, y=attendance)) +
  geom_point(alpha=1/5) + theme_few() +
  geom_smooth(method='lm', se=F, color="black") +
  annotation_custom(text) +
  xlab("Capacity") + ylab("Attendance")
attendance_corr
#ggsave("graphs/correlation_minus0s.png", height=6, width=9)
```

### Figure 5 - Max capacity by game time variance by team 2020-21

```{r fig5}
d21f5 <- d21 %>%
  mutate(team=word(hometeam, - 1))

## Plot Figure 5 and save    
capacity_time <- ggplot(d21f5, aes(x=gamenumber, y=capacity)) +
  geom_line() + facet_wrap("team") + theme_few() +
  xlab("Game Number") + ylab("Capacity")
capacity_time
#ggsave("graphs/capacity_time.png", height=6, width=9)
```

## 3) Paper Calculations

"We show that home teams win by $2.13$ points, on average, when fans are present at games compared with $0.44$ points when
no fans are present."

```{r calc1}
fans21 <- d21_1 %>% filter(season=="2021 (Fans)")
nofans21 <- d21_1 %>% filter(season=="2021 (No Fans)")

print(str_c("Average home margin when fans were present in the 2020-21 season = ", round(mean(fans21$homemargin), digits=2),". Average home marin when fans were not present in the 2020-21 season = ",round(mean(nofans21$homemargin), digits=2),"."))
```

"During the 2020-21 regular season, home teams had an average point advantage of $0.94$ points, which was noticeably lower than the $2.43$-point home court advantage over the prior six seasons and 2021-22 season."

```{r calc2}
di21_1 <- d %>% filter(season==2021)
di21_2 <- d %>% filter(season!=2021)

print(str_c("Average home margin in the 2020-21 season = ", round(mean(di21_1$homemargin), digits=2)))

print(str_c("Average home margin in the 2014-15 to 2019-20 seasons and 2021-22 season = ", round(mean(di21_2$homemargin), digits=2)))
```

"In the 438 games without fans in attendance, the home court advantage was 0.44 points and insignificantly different from zero (t-statistic: 0.609, p-value: 0.543). It is also significantly lower than in prior seasons (t-statistic: 2.705, p-value: 0.007). With fans in attendance, in contrast, the home court advantage increased to 2.13, which was significantly greater than zero points (t-statistic: 3.085, p-value: 0.002) and very much in line with the home court advantage observed in prior seasons (t-statistic: 0.420; p-value: 0.675). However, the difference between average home court advantage conditional on the presence of fans during the 2020-21 season is only marginally significant (t-statistic: 1.70; p-value: 0.090)."

``` {r ttests}
ttest1 <- t.test(margins_nofans)
ttest1$statistic
ttest1$p.value

ttest2 <- t.test(margins_non21, margins_nofans)
ttest2$statistic
ttest2$p.value

ttest3 <- t.test(margins_fans)
ttest3$statistic
ttest3$p.value

ttest4 <- t.test(margins_non21, margins_fans)
ttest4$statistic
ttest4$p.value
    
ttest5 <- t.test(margins_fans, margins_nofans)
ttest5$statistic
ttest5$p.value
```

### Team winning percentages - FiveThirtyEight

```{r winningpct}

## Create set-up values
exponent = 14.3
pre = 0.44 # Home court advantage without attendance
post1 = 2.13 # Home court advantage with attendance (means)
post2 = pre + 1.742*(mean(d21corr$attendance)/1000) # Home court advantage with av.2020 attendance (regression)
post3 = pre + 4.527 # Home court advantage with positive capacity (regression)
ppg = 112.1 # Points per game 2020-21 (basketball-reference.com)
games = 41 # Number of home games

## Create Pythagorean function
pythagorean = function(margin, exponent, games, ppg) {
  (ppg + margin/2)^exponent / ((ppg + margin/2)^exponent + (ppg - margin/2)^exponent)
} 

# Create base result
base = pythagorean(pre, exponent, games, ppg) * games

# Compare effect of home court advantage with attendance
case1 = pythagorean(post1, exponent, games, ppg) * games
(case1 - base)
# Compare effect of home court advantage with additional 1000 in attendance
mean(d21corr$attendance)
case2 = pythagorean(post2, exponent, games, ppg) * games
(case2 - base)
# Compare effect of home court advantage with positive capacity
case3 = pythagorean(post3, exponent, games, ppg) * games
(case3 - base)
```